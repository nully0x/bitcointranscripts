---
title: Challenges in implementing coinjoin in hardware wallets - Pavol Rusnak
transcript_by: nully0x via review.btctranscripts.com
media: https://www.youtube.com/watch?v=gqINXwsR33g
tags: ["wallets","Hardware Wallet"]
speakers: ["Pavol Rusnak"]
categories: ["conference"]
date: 2022-03-02
---

<h1>Intro</h1>
<p>So, hi everyone.  I'm Pablo Dusnak, our known &quot;Stick&quot; in the Bitcoin community, and I'm the co-founder of Satashalops,  the company that brought treasure.  And today I'm going to be talking about challenges implementing content in the hardware  wallets.<br>
But first, maybe just summarize why prowess matters.  There are a lot of reasons, but I think this is the most important autonomy, because privacy  allows individuals to have control over their personal information, enabling them to  make independent choices and decisions.  Then, personal safety, privacy protects individuals from harm or danger, such as stalking,  harassment or identity theft.  Some of expression privacy encourages free expression and open communication.  Trust, privacy is essential for building trust between individuals and institutions.  Then equality, privacy helps ensure that everybody is treated equally, regardless of  phrase, gender, religion, and so on.  Democracy is really critical to maintaining democracy by enabling citizens to communicate  freely with one another and their representatives.  And last but not least, innovation, privacy promotes innovation by providing the safe environment  for individuals and companies to experiment and develop new ideas and technologies without  fear of theft and abuse.  So it can be summarized, sorry, privacy is a fundamental human right that protects individual  autonomy, safety, freedom, as well as promoting trust, equality, democracy, and innovation.  So let us understand what is the state of Bitcoin privacy.  Transactions are recorded on a public blockchain, can be traced and analyzed by anyone, even  retroactively.  Safety of transaction parties is not necessarily known, but these identities are very often  linked through various means.  So that means IP address tracking, public information disclosure, you know, if you put on your  Twitter or not-stere profile, this is my Bitcoin address for the for donations.  And especially in combination with address reuse, this is a big issue, but not as big as  exchange and their novel customer's practices.  What are the privacy enhancing technologies?  So there are confidential transactions, which is a method which obfuscates transacted  amounts, but we need to verify that no bitcoins were created or destroyed in the process.  And these are usually deployed as sidechains.  We don't have confidential transactions in the Bitcoin base layer.  Then there is lightning network, which helps with privacy because blockchain now shows  only channel opens and closes, but it doesn't show individual transactions.  There are services like Tor and VPNs where you can hide your users' IP address and  location.  And it's harder to link transactions together because for example in Tor, you can switch  identities when performing different transactions and then you seem as a different person  online.  And of course, there is coin join.  So what's <strong>coin join</strong>?  It's privacy enhancing technique to increase the anonymity of Bitcoin transactions.  And it happens when multiple parties agree to merge their transactions, meaning inputs  and outputs, into single larger transactions.  And the resulting transaction makes it more challenging to link individual inputs and outputs  to their respective owners.  So usually, coin join is much bigger than this, but this is just an example.  You see there are three participants on the input side.  And by looking at the output side of things, you can probably guess that this change output  belongs to that person and so on.  But you can't really tell nothing about this output.  You don't know whether this output belongs to that person or that person or that person.  So basically, the idea is let's create outputs of the same size and these clusters  of same sized outputs, they gain something that we call k anonymity.  So this group of outputs have k anonymity where k is 5 because you can't really guess  which person this output belongs to.  What are phases of a coin join?  First, there is input registration where each participant registers their input add a coordinator.  That this happens usually via tour.  So different or identity is used for each input.  And for each successful input registration, a coordinator gives participant something  I will call a token, but it's not like a cryptocurrency token.  And it can be, for example, a shomian blind signature that's used in Wazaabhi one or key  verification anonymous credential which is used in Wazaabhi protocol in Wazaabhi two.  I really don't get into the details what this actually means.  But the important thing is that you are given this token and you can use this token in  the second phase which is output registration where each participant registers their outputs  at the coordinator via different or identity again.  And what's important here is that these are different identities than used in the input  registration, so there is no link.  And each output registration presents a token which is a proof that you are allowed to register  output of a certain size.  And this token is burned which means essentially that the conjunction coordinator marks it  as used.  And usually this token is tied to a conjunction around.  So it's not usable in other round.  And that's good because then this smart or useless can be discarded after the conjunction  round.  They don't grow infinitely over the time.  There are certain techniques where these tokens are not limited to a certain point of time,  but then we are talking about various e-cash implementations such as cashew or verimine.  But back to conjoin, these tokens are limited just for this particular round.  And then there is signing, so after inputs and outputs registration phase, we transact,  sorry, to compose the transaction and send each participant to be signed.  We can use different identities, but it doesn't really matter.  We can even use identities from step one because if you were registering input in that  phase, it's 100% sure that you will be signing the same input in that case.  And all signatures are collected from participants.  And when the final composite transaction is valid, then the conjunction round is successful  and transaction is broadcast data network.  So what about the hardware wallet?  Usually if you have a regular transaction on conjoin one, a hardware wallet signs transactions  with user interaction.  What it means, it means that user confirms output addresses, which is basically output  the output, then the user confirms output demands and mining fee, which is usually  some of outputs minus some inputs.  Sorry, it should be the opposite.  And there is an art asterisk there because usually hardware wallets, if they don't detect  extremely high fees, they don't really ask about this.  So I will talk about it a little bit later.  And for conjoin, we need transaction signing with no user interaction.  Why?  Because we don't really know when the other parties are ready for signing and when we reach  the signing phase.  And usually we need more congions around than one.  And we really don't want to force users to sit in front of their computers for two days  or something like that.  And in that case, hardware wallet needs to do several things.  So it has to check if some of my inputs equals some of my outputs plus small app so on,  which is mining fee, coordinator fee, and so on.  And the trick here is how to correctly identify which inputs are mine, which outputs are  mine, and of course their amounts.  So let me talk about pre-segment fee attack or spoof input amount.  The idea is that some inputs mean some of outputs is the mining fee, but transaction inputs  do not contain any amounts.  They contain just the transaction hash and transaction index.  So what if an attacker lies about amount of an input?  You can, for example, spend 10 BTC input, but lie that is only one BTC.  Remember that on hardware wallet you just confirm the outputs, not the inputs.  And then a user will spend nine bitcoins on transaction fees.  So on transfer we always require full previous transactions.  So the hardware wallet can compute the real input of which is being spent.  And this can be a little problematic when the transactions you are spending are pretty  big.  And as I said, when the fee is high, we show the warning, when the fee is very high, we  throw an error, if the fee is below this threshold, then we just let it pass.  So there was a segment version zero, does it fix this?  3-143 signatures commit also to the amount of spent input, which is good.  And if the attacker lies about the UTEC amount, then the signature is simply not valid in  the Bitcoin network.  Are we done?  Well, no.  Because segment version zero does not fix this entirely.  The victim has to be 143 UTECs, or 15 and 20 BTC.  The malware asks the user to confirm the transaction, which takes input one as 15 BTC input  and input two.  And it presents it as it has only five bitcoins plus one Satoshi, BTC, then the user chooses  the outputs and the var- exchange output if necessary.  The user confirms transaction.  They only confirms the outputs.  And they think they are spending 20 BTC plus one Satoshi fee.  Then the malware frauds an error and tells the user to confirm the transaction again.  But this time, the malware uses input one, but tells the hardware, hey, this is just one Satoshi  and input two as 20 bitcoins.  So from the user's perspective, they don't see the inputs.  They just see the output side of things.  So it's the center transaction as they were signing it earlier.  And the user sees an apparently identical transaction and again, confirm spending 20 BTC  plus one Satoshi.  But actually they spent 15 plus 20 BTC when the malware combines these two signatures  and creates a transaction that spans both of these.  So this means that again, 15 bitcoins are spent as a transaction fee.  Then there was a significant version one.  Does it fix this?  Now be 341 signatures commit to all input amounts.  That's great.  So all signatures in the transaction commits to all input amounts.  They also commit to the inputs script, which is great.  And attacker kind of really modified the inputs script.  But are we done?  What do you think?  No.  Not yet.  The attacker can also lie about the inputs script that it doesn't really belong to the wallet  and full folder hardware wallet into not taking this input into account.  And you can again perform the same two passing extract and collect two signatures combined  them and do essentially the same attack.  This issue was encountered by my colleague Andrew Kozwick in 2010, too, while working on  conjoin.  And he immediately proposed that BIP-341 signatures should commit to all input scripts, not  just the one input script that is being signed.  And luckily there wasn't very long discussion and all parties really agreed that it should  be done this way.  There is no reason or not to do it.  So, segment version one does fix this issue and segment version one input signatures  commit to previous transaction hash in the pre-index amount being signed.  All amounts in the transaction, input script being signed, all input scripts.  So yeah.  Actually this is why conjoin really loves top root because having signatures that commit  to everything is great for automated transactions containing external inputs, for example  conjoin.  And attacker cannot really change input, remote, or input script because if they do then  the whole transaction is ruined because of the wrong signature.  And there is one more thing we have to figure out and that attacker can still withhold  some kind of information.  For example, whether the input belongs to the hardware wallet, maybe the attacker doesn't  really want to tell the hardware wallet which BIP-32 path is being used and it's really  impossible for hardware wallet to figure it out on their own.  And the input would not be taken into evaluation.  So we need to somehow assert an ownership of all inputs.  So how do we do that?  Yeah.  And this is important for all transactions with external inputs.  Not only for conjoin but also the whole funded lightning channels, etc.  And we need a mechanism to reliable determinant for which input whether it belongs to the  wallet or not.  And how do we do that?  This is described in slip 19.  Slip is like subtlety-slaps equivalent of BIP.  And the slip 19 is named proof of ownership and it works that way.  We have essentially three pieces information which are signed.  The first if ownership identifier which allows us to efficiently determine whether the wallet  is able to spend a new take so having given script PIP key or not.  It's a very simple construction where basically you take a symmetric key derived from  master seed and then use H-MEC to process the risky and script PIP key as its message.  And other piece of information is the script PIP key itself.  And then also we have additional commitment data which are arbitrary.  You don't even have to use that if you don't want to.  But basically it's random 256-bit value which in case of conjoin we use 192-bit conjoin  coordinator ID and 64-bit conjoin round ID.  But it can be any value depending on what kind of application I'm building.  And everything is signed while I'm at the described in March 2020 edition of BIP  322 generic signed message format.  So maybe I will end my talk by asking why people do not use conjoin much.  So first of all I guess the real issue here is like of awareness which hopefully I'm kind  of fixing now.  People don't know that conjoin exists.  People don't know they need privacy at all.  They maybe don't care about privacy at all.  I think we live in a bubble and there are like 99% people out there that don't really  care about it.  And of course complexity I mean I said probably thousands several thousand pieces of new  information in a couple of minutes and I didn't really scratch even the top of it.  I mean like of integration with hardware wallets because conjoin wallets have usually been  hot wallets and you don't really want to put all of your stash in the hot wallet.  And last but not least there is a scare of legal implications.  I'm really hoping that we are going to be addressing all four of these points by introducing  a treasure and Wazabhi collaboration which will be launched later this month.  And I think that's all from my side and if there are any questions I'm I still think we  have like five minutes so I'm here to answer them.  Sorry?  Can you go back a slide?  Yes.  I just really thought it was a really nice slide to finish on.  I'm not sure easily with Trezor who has a question I'll run towards you now.  Anyways yes.  Can you hear me?  I know that last year Adam Gibson did a workshop on conjoin and it seemed like one of the  other issues that he talked about was that we don't really know who the other participants  are and it seems like another fear is that maybe all the other participants are a single  entity that are targeting you.  What are your thoughts on that?  I think Max could probably give more elaborate answer but my take is we should strive  to make conjoin as big as possible and I don't know what's the current limit in Wazabhi  coordinator but I think it's 150 inputs at least.  Something around that and it's very hard to pull a simple attack if there are like  just five participants it's much much much easier.  And if there will be, I mean I hoping that this integration will attract even more people  to conjoin and I think we can start to raise this bar and limit up.  So yeah, I mean that's my answer there.  Thank you.  Thank you.  Thank you.  Thank you.  Thank you.  Thank you.  Thank you.  Thank you.  I'm going to go to an exchange.  An exchange can they refuse like exchange.  Yeah.  So the question is what's the relationship or how do exchanges look at conjoin transactions  and I guess that's really a question for them not for me.  But I mean there are not all exchanges have the same you know patterns of behaviour and  some of them are marking all conjoin as something legal.  They don't want to happen.  They don't want to accept coins from conjoin.  I know there are even some more crazy exchanges that are looking in transactions after  you withdraw coins from exchanges and they say hey you withdraw your coins from an exchange  and you do it like you can't join several days after we don't like this and I think it's  really draconian.  But what I also believe we are doing here we are attracting really really huge user base  to conjoin.  So I hope that earlier it was very easy for exchanges to dismiss conjoin or something  illegal but if there will be like I don't know several hundred thousand legitimate  resular users doing that hopefully they will change his behaviour and if they want  then I guess they have problems.  So it's like a game theory slash four dimensional chess we are playing here.  I think we have time for one last quick question.  My name is Robert I run and start nine notes.  What's the biggest justification in terms of legal to use coin join?  I mean they are coming off to developers right or maybe someone here how you justify it.  For example there is a pretty big chain in the chagry public who is selling electronics  and I really like buying electronics from that store by using bitcoins but I don't really  want to be re-willing all my stash to them and it's very easy if I don't use conjoin  because you can just look at the transactions of the blockchain and write to a cleverly  CEO.  So this is a person that buys electronics I'm kind of KYC to this electronics vendor because  I just ship these electronics to my place and I mean they're probably not doing that but  they could if they want.  So if I use conjoin then I'm basically putting the wall between the cons I'm spending  at this store and between the one I am.</p>

